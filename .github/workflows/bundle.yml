name: Bundle release

on:
  release:
    types: [ published ]
  # Allow manually triggering the workflow.
  workflow_dispatch:

# Cancels all previous workflow runs for the same branch that have not yet completed.
concurrency:
  # The concurrency group contains the workflow name and the branch name.
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  bundle:
    name: Add zip to release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.release.target_commitish }}

      - uses: "shivammathur/setup-php@v2"
        with:
          php-version: "7.4"

      - name: Install Composer dependencies
        uses: ramsey/composer-install@v2
        with:
          composer-options: '-oa --no-dev'

      - name: Set Node.js version
        uses: actions/setup-node@v3
        with:
          node-version: 14

      - name: Cache node modules
        uses: actions/cache@v1
        with:
          path: node_modules
          key: ${{ runner.OS }}-build-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.OS }}-build-${{ env.cache-name }}-
            ${{ runner.OS }}-build-
            ${{ runner.OS }}-

      - name: Install node packages
        run: npm install

      - name: Bundle assets
        run: npm run build --no-dev --no-progress

      - name: Move bundled files to a subfolder
        run: |
          chmod +x "$GITHUB_WORKSPACE/bin/bundle-plugin.sh"
          bash "$GITHUB_WORKSPACE/bin/bundle-plugin.sh" "$GITHUB_WORKSPACE"
        shell: bash

      - name: Archive assets
        uses: thedoctor0/zip-release@master
        with:
          type: 'zip'
          filename: 'release.zip'
          exclusions: '*.git* *tests/ bin/ assets/ *.eslintignore *.eslintrc *.stylelintrc CODE_OF_CONDUCT.md *.config.js *.yml *.xml *.xml.dist *.neon.dist composer.json composer.lock package.json package-lock.json node_modules/*'
          path: 'eightshift-forms/'
          directory: '.'

      - name: Upload zip to release
        uses: AButler/upload-release-assets@v2.0
        with:
          files: 'release.zip'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
